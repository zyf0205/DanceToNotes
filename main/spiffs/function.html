<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>è®¾å¤‡æ§åˆ¶å°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: #f5f6fa;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: 20px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #ddd;
            padding: 24px;
        }

        h1 {
            color: #2d3436;
            text-align: center;
            margin-bottom: 24px;
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            margin: 16px 0;
            border-radius: 6px;
            border-left: 4px solid #0984e3;
        }

        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
        }

        .btn {
            padding: 8px 16px;
            background: #0984e3;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
        }

        .btn:hover {
            background: #74b9ff;
        }

        .btn:disabled {
            background: #b2bec3;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #d63031;
        }

        .btn-danger:hover {
            background: #e17055;
        }

        .data {
            font-family: monospace;
            background: #2d3436;
            color: #ddd;
            padding: 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 14px;
            min-height: 60px;
        }

        .online {
            color: #00b894;
        }

        .offline {
            color: #d63031;
        }

        .log {
            background: #2d3436;
            color: #ddd;
            padding: 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 12px;
            height: 120px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸµ DanceToNotes æ§åˆ¶å°</h1>

        <div class="card">
            <h3>è®¾å¤‡çŠ¶æ€</h3>
            <div class="status">
                <span>è®¾å¤‡è¿æ¥ï¼š</span>
                <span id="device-status" class="online">åœ¨çº¿</span>
            </div>
            <div class="status">
                <span>æ•°æ®æ›´æ–°ï¼š</span>
                <span id="data-status" class="offline">å·²åœæ­¢</span>
            </div>
            <div class="status">
                <span>æœ€åæ›´æ–°ï¼š</span>
                <span id="last-update">--</span>
            </div>
        </div>

        <div class="card">
            <h3>å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®</h3>
            <div class="data" id="sensor-data">
                ç­‰å¾…ä¼ æ„Ÿå™¨æ•°æ®...
            </div>
            <button class="btn" onclick="getSensorData()">è·å–æ•°æ®</button>
            <button class="btn" onclick="toggleAutoUpdate()" id="autoUpdateBtn">å¼€å§‹è‡ªåŠ¨æ›´æ–°</button>
        </div>

        <div class="card">
            <h3>è®¾å¤‡æ§åˆ¶</h3>
            <button class="btn btn-danger" onclick="restartDevice()">é‡å¯è®¾å¤‡</button>
            <button class="btn btn-danger" onclick="resetWifi()">é‡ç½®WiFi</button>
        </div>

        <div class="card">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <div class="log" id="operation-log">
                ç³»ç»Ÿå°±ç»ª...
            </div>
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        var isAutoUpdating = false;
        var updateInterval = null;

        function addLog(message) {
            var log = document.getElementById('operation-log');
            var timestamp = new Date().toLocaleTimeString();
            log.innerHTML += '[' + timestamp + '] ' + message + '<br>';
            log.scrollTop = log.scrollHeight;
        }

        function updateLastUpdateTime() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        function getSensorData() {
            fetch('/sensor-data')
                .then(response => response.json())
                .then(data => {
                    var sensorDiv = document.getElementById('sensor-data');
                    sensorDiv.innerHTML =
                        'åŠ é€Ÿåº¦è®¡:<br>' +
                        '&nbsp;&nbsp;X: ' + data.accel.x.toFixed(2) + '<br>' +
                        '&nbsp;&nbsp;Y: ' + data.accel.y.toFixed(2) + '<br>' +
                        '&nbsp;&nbsp;Z: ' + data.accel.z.toFixed(2) + '<br>' +
                        'é™€èºä»ª:<br>' +
                        '&nbsp;&nbsp;X: ' + data.gyro.x.toFixed(2) + '<br>' +
                        '&nbsp;&nbsp;Y: ' + data.gyro.y.toFixed(2) + '<br>' +
                        '&nbsp;&nbsp;Z: ' + data.gyro.z.toFixed(2);

                    document.getElementById('device-status').textContent = 'åœ¨çº¿';
                    document.getElementById('device-status').className = 'online';
                    updateLastUpdateTime();
                    addLog('è·å–ä¼ æ„Ÿå™¨æ•°æ®æˆåŠŸ');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('device-status').textContent = 'ç¦»çº¿';
                    document.getElementById('device-status').className = 'offline';
                    addLog('è·å–ä¼ æ„Ÿå™¨æ•°æ®å¤±è´¥: ' + error.message);
                });
        }

        function toggleAutoUpdate() {
            var btn = document.getElementById('autoUpdateBtn');
            var statusSpan = document.getElementById('data-status');

            if (isAutoUpdating) {
                clearInterval(updateInterval);
                isAutoUpdating = false;
                btn.textContent = 'å¼€å§‹è‡ªåŠ¨æ›´æ–°';
                statusSpan.textContent = 'å·²åœæ­¢';
                statusSpan.className = 'offline';
                addLog('åœæ­¢è‡ªåŠ¨æ›´æ–°');
            } else {
                updateInterval = setInterval(getSensorData, 1000);
                isAutoUpdating = true;
                btn.textContent = 'åœæ­¢è‡ªåŠ¨æ›´æ–°';
                statusSpan.textContent = 'è¿è¡Œä¸­';
                statusSpan.className = 'online';
                addLog('å¼€å§‹è‡ªåŠ¨æ›´æ–°ä¼ æ„Ÿå™¨æ•°æ®');
                getSensorData(); // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
            }
        }

        function restartDevice() {
            if (confirm('ç¡®å®šè¦é‡å¯è®¾å¤‡å—ï¼Ÿ')) {
                fetch('/device-control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'restart'
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addLog('è®¾å¤‡é‡å¯å‘½ä»¤å·²å‘é€');
                            alert('è®¾å¤‡æ­£åœ¨é‡å¯...');
                        } else {
                            addLog('è®¾å¤‡é‡å¯å¤±è´¥: ' + data.message);
                            alert('é‡å¯å¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        addLog('é‡å¯å‘½ä»¤å‘é€å¤±è´¥: ' + error.message);
                    });
            }
        }

        function resetWifi() {
            if (confirm('ç¡®å®šè¦é‡ç½®WiFié…ç½®å—ï¼Ÿè®¾å¤‡å°†é‡æ–°è¿›å…¥é…ç½‘æ¨¡å¼ã€‚')) {
                fetch('/device-control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'reset_wifi'
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addLog('WiFié…ç½®é‡ç½®æˆåŠŸ');
                            alert('WiFié…ç½®å·²é‡ç½®ï¼Œè®¾å¤‡å°†é‡æ–°è¿›å…¥é…ç½‘æ¨¡å¼');
                        } else {
                            addLog('WiFié…ç½®é‡ç½®å¤±è´¥: ' + data.message);
                            alert('é‡ç½®å¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        addLog('WiFié‡ç½®å‘½ä»¤å‘é€å¤±è´¥: ' + error.message);
                    });
            }
        }

        function clearLog() {
            document.getElementById('operation-log').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º...<br>';
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ä¸€æ¬¡æ•°æ®
        window.onload = function () {
            getSensorData();
        };
    </script>
</body>

</html>